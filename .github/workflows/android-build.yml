name: Flutter CI - V1 Check + Dependency Check + Build APK

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  flutter-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.22.2   # Use current stable version

      # 1. Scan for V1 embedding in Android folder
      - name: Scan Android code for V1 embedding
        run: |
          echo "ğŸ” Scanning android/ folder for Flutter V1 embedding markers..."
          found=false
          if grep -RIn "io.flutter.app.FlutterActivity" android/; then found=true; fi
          if grep -RIn "GeneratedPluginRegistrant" android/; then found=true; fi
          if grep -RIn "registerWith(" android/; then found=true; fi
          if grep -RIn "io.flutter.plugin.common.PluginRegistry" android/; then found=true; fi

          if [ "$found" = true ]; then
            echo "::error:: âŒ V1 embedding code detected above. Please migrate to V2."
            exit 1
          else
            echo "âœ… No V1 embedding code found in android/ folder."
          fi

      # 2. Dependency check
      - name: Check outdated dependencies
        run: |
          echo "ğŸ“¦ Checking for outdated Flutter packages..."
          flutter pub get
          flutter pub outdated || true

      # 3. Build APK
      - name: Build release APK
        run: flutter build apk --release --split-per-abi

      # 4. Upload APK artifact
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/*.apk
