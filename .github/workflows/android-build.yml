name: Detect Flutter V1 Embedding

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  scan-v1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Scan Android code for V1 embedding
        run: |
          echo "üîç Scanning android/ folder for Flutter V1 embedding markers..."
          found=false

          # Only check android/ folder (ignore assets, pdf, workflows etc.)
          if grep -RIn "io.flutter.app.FlutterActivity" android/; then found=true; fi
          if grep -RIn "GeneratedPluginRegistrant" android/; then found=true; fi
          if grep -RIn "registerWith(" android/; then found=true; fi
          if grep -RIn "io.flutter.plugin.common.PluginRegistry" android/; then found=true; fi

          if [ "$found" = true ]; then
            echo "::error:: ‚ùå V1 embedding code detected above. Please migrate to V2."
            exit 1
          else
            echo "‚úÖ No V1 embedding code found in android/ folder."
          fi

      - name: Show MainActivity (first 40 lines)
        run: |
          echo "üìÇ Preview of MainActivity file:"
          find android/app/src/main -type f -name "MainActivity.*" | while read file; do
            echo "---- $file ----"
            head -n 40 "$file"
          done || true
